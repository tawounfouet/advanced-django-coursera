# Task Queuing: Question 4

## Question 4
Just in case someone edits the database directly without using Django, we should run the update_count_for_author() task every day to make sure the book counts are kept updated. We can schedule this to happen using Celery beat.

First you will need to add django_celery_beat to INSTALLED_APPS and then migrate the database when this is done.
python3 manage.py migrate

Next implement the body of the setup_book_count_update_schedule() function in helpers.py. This function should create a new IntervalSchedule that is set to execute every day. Then create a PeriodicTask using this schedule, to execute the task books.tasks.author_count_update. Make sure the PeriodidTask has a name, but it does not matter what this is.

You can execute the setup_book_count_update_schedule() to test it, by using the question4 management command:
python3 manage.py question4

If you try to test this with Celery beat you will need to wait a day, so instead you can check through the Django admin that it looks OK, or run the unit tests for this question.
TRY IT

Before you can log into the Django admin, you first need to create an admin account. Run the command in the terminal. Enter information for the super user. Note: you will need this information for Question 5 as well.
python3 manage.py createsuperuser

Now start the dev server and log in to the Django admin.
START DEV SERVER

View Admin Page

## Task
```python
# helpers.py

# Question 4 & 5: Add any imports you need

from books.models import Book


def update_count_for_author(author):
    """Update the count of books (`book_count`) for `author`."""
    author.book_count = Book.objects.filter(author=author).count()
    author.save()


def setup_book_count_update_schedule():
    """Set up an `IntervalSchedule` and `PeriodicTask` to execute `books.tasks.author_count_update` daily."""
    # Question 4: Implement this function body


def setup_author_notify_schedule():
    """
    Set up a `CrontabSchedule` and `PeriodicTask` to execute `books.tasks.author_notify` at 6AM on the first day of
    every month.
    """
    # Question 5: Implement this function body
```

```python
# settings.py

"""
Django settings for module2 project.

Generated by 'django-admin startproject' using Django 3.2.5.

For more information on this file, see
https://docs.djangoproject.com/en/3.2/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/3.2/ref/settings/
"""

from pathlib import Path
import os

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/3.2/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = "django-insecure-d2!+3h*%-)-n1c3ac11t$1$-#8b=6!)a6rq+5%5pym-(9ili6p"

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = ["localhost", "0.0.0.0", ".codio.io", os.environ.get('CODIO_HOSTNAME') + '-8000.codio.io']
X_FRAME_OPTIONS = 'ALLOW-FROM ' + os.environ.get('CODIO_HOSTNAME') + '-8000.codio.io'
CSRF_COOKIE_SAMESITE = None
CSRF_TRUSTED_ORIGINS = [os.environ.get('CODIO_HOSTNAME') + '-8000.codio.io']
CSRF_COOKIE_SECURE = True
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SAMESITE = 'None'
SESSION_COOKIE_SAMESITE = 'None'


# Application definition

INSTALLED_APPS = [
    "django.contrib.admin",
    "django.contrib.auth",
    "django.contrib.contenttypes",
    "django.contrib.sessions",
    "django.contrib.messages",
    "django.contrib.staticfiles",
    "books",
    # Question 1 & 4: Add your apps here
]

MIDDLEWARE = [
    "django.middleware.security.SecurityMiddleware",
    "django.contrib.sessions.middleware.SessionMiddleware",
    "django.middleware.common.CommonMiddleware",
#     "django.middleware.csrf.CsrfViewMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    "django.contrib.messages.middleware.MessageMiddleware",
#     "django.middleware.clickjacking.XFrameOptionsMiddleware",
]

ROOT_URLCONF = "module2.urls"

TEMPLATES = [
    {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [],
        "APP_DIRS": True,
        "OPTIONS": {
            "context_processors": [
                "django.template.context_processors.debug",
                "django.template.context_processors.request",
                "django.contrib.auth.context_processors.auth",
                "django.contrib.messages.context_processors.messages",
            ],
        },
    },
]

WSGI_APPLICATION = "module2.wsgi.application"


# Database
# https://docs.djangoproject.com/en/3.2/ref/settings/#databases

DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.sqlite3",
        "NAME": BASE_DIR / "db.sqlite3",
    }
}


# Password validation
# https://docs.djangoproject.com/en/3.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        "NAME": "django.contrib.auth.password_validation.UserAttributeSimilarityValidator",
    },
    {
        "NAME": "django.contrib.auth.password_validation.MinimumLengthValidator",
    },
    {
        "NAME": "django.contrib.auth.password_validation.CommonPasswordValidator",
    },
    {
        "NAME": "django.contrib.auth.password_validation.NumericPasswordValidator",
    },
]


# Internationalization
# https://docs.djangoproject.com/en/3.2/topics/i18n/

LANGUAGE_CODE = "en-us"

TIME_ZONE = "UTC"

USE_I18N = True

USE_L10N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/3.2/howto/static-files/

STATIC_URL = "/static/"

# Default primary key field type
# https://docs.djangoproject.com/en/3.2/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = "django.db.models.BigAutoField"

# Question 1: Add your settings here
```


## Solution
```python
# helpers.oy

from django_celery_beat.models import IntervalSchedule, PeriodicTask

# existing update_count_for_author function

def setup_book_count_update_schedule():
    """Set up an `IntervalSchedule` and `PeriodicTask` to execute `books.tasks.author_count_update` daily."""
    # Question 4: Implement this function body
    day_schedule, _ = IntervalSchedule.objects.get_or_create(
        every=1, period=IntervalSchedule.DAYS
    )
    PeriodicTask.objects.create(
        name="author_count_update",
        task="books.tasks.author_count_update",
        interval=day_schedule,
    )
```
- Install django_celery_beat in the INSTALLED_APPS list.


```python
# settings.py

INSTALLED_APPS = [
    "django.contrib.admin",
    "django.contrib.auth",
    "django.contrib.contenttypes",
    "django.contrib.sessions",
    "django.contrib.messages",
    "django.contrib.staticfiles",
    "books",
    # Question 1 & 4: Add your apps here
    "django_celery_results",
    "django_celery_beat",
]
```
- Import IntervalSchedule and PeriodicTask.
- Create a daily interval schedule.
- Create a periodic task with a name, that calls the author_count_update task, and makes use of the daily interval schedule.
